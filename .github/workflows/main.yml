name: Build package for macOS

on: [push]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Mount bazel cache
      uses: actions/cache@v1
      with:
        path: "/Users/runner/.cache/bazel"
        key: bazel

    - name: Install bazelisk
      run: |
        curl -LO "https://github.com/bazelbuild/bazelisk/releases/download/v1.3.0/bazelisk-darwin-amd64"
        mkdir -p "${GITHUB_WORKSPACE}/bin/"
        mv bazelisk-darwin-amd64 "${GITHUB_WORKSPACE}/bin/bazel"
        chmod +x "${GITHUB_WORKSPACE}/bin/bazel"
        
    - name: Install Java Development Kit 8
      run: |
        curl -LO "https://github.com/AdoptOpenJDK/openjdk8-binaries/releases/download/jdk8u242-b08/OpenJDK8U-jdk_x64_mac_hotspot_8u242b08.pkg"
        sudo installer -pkg OpenJDK8U-jdk_x64_mac_hotspot_8u242b08.pkg -target /
        export JAVA_HOME=/Library/Java/JavaVirtualMachines/adoptopenjdk-8.jdk/Contents/Home
        
    - name: Install Android SDK and NDK
      run: |
        curl -LO "https://dl.google.com/android/repository/sdk-tools-darwin-3859397.zip"
        mkdir -p "${GITHUB_WORKSPACE}/android/"
        mv sdk-tools-darwin-3859397.zip ${GITHUB_WORKSPACE}/android/
        cd ${GITHUB_WORKSPACE}/android/
        unzip sdk-tools-darwin-3859397.zip
        mkdir licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee\n" > licenses/android-sdk-license
        echo "84831b9409646a918e30573bab4c9c91346d8abd\n" > licenses/android-sdk-preview-license
        echo "859f317696f67ef3d7f30a50a5560e7834b43903\n" > licenses/android-sdk-arm-dbt-license
        echo "601085b94cd77f0b54ff86406957099ebe79c4d6\n" > licenses/android-googletv-license
        echo "33b6a2b64607f11b759f320ef9dff4ae5c47d97a\n" > licenses/google-gdk-license
        echo "d975f751698a77b662f1254ddbeed3901e976f5a\n" > licenses/intel-android-extra-license
        echo "e9acab5b5fbb560a72cfaecce8946896ff6aab9d\n" > licenses/mips-android-sysimage-license
        tools/bin/sdkmanager "platforms;android-26" "build-tools;29.0.2" ndk-bundle
        export ANDROID_HOME=${GITHUB_WORKSPACE}/android/
        export ANDROID_NDK_HOME=${GITHUB_WORKSPACE}/android/ndk-bundle
        
    - name: Increase the maximum number of OS file handles
      run: |
        sudo sysctl -w kern.maxfiles=122880
        sudo sysctl -w kern.maxfilesperproc=102400
        echo ulimit -S -n 102400 >> ~/.bashrc
        
    - name: Build
      run: |
        "${GITHUB_WORKSPACE}/bin/bazel" build pkg
